rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user is a participant in the conversation
    function isParticipant(conversationData) {
      return isSignedIn() && request.auth.uid in conversationData.participants;
    }
    
    // Users collection - for storing user profile data
    match /users/{userId} {
      // Users can read their own profile and profiles of users they're chatting with
      allow read: if isSignedIn();
      
      // Users can only create/update their own profile
      allow create, update: if isSignedIn() && request.auth.uid == userId;
      
      // Prevent deletion of user profiles
      allow delete: if false;
    }
    
    // Conversations collection rules - SECURED
    match /conversations/{conversationId} {
      // Allow creating a conversation only if:
      // 1. User is authenticated
      // 2. User's ID is in the participants array
      // 3. Conversation has exactly 2 participants
      allow create: if isSignedIn() 
        && request.auth.uid in request.resource.data.participants
        && request.resource.data.participants.size() == 2;
      
      // Allow reading conversations only if user is a participant
      allow read: if isSignedIn() 
        && request.auth.uid in resource.data.participants;
      
      // Allow updating conversations only if:
      // 1. User is authenticated
      // 2. User is a participant
      // 3. Participants array is not modified (prevents adding/removing people)
      allow update: if isSignedIn() 
        && request.auth.uid in resource.data.participants
        && request.resource.data.participants == resource.data.participants;
      
      // Prevent deletion of conversations
      allow delete: if false;
      
      // Messages subcollection in conversations - SECURED
      match /messages/{messageId} {
        // Allow creating a message only if:
        // 1. User is authenticated
        // 2. User is a participant in the parent conversation
        // 3. The senderId matches the authenticated user
        allow create: if isSignedIn() 
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants
          && request.resource.data.senderId == request.auth.uid;
        
        // Allow reading messages only if user is a participant in the conversation
        allow read: if isSignedIn() 
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        // Allow updating messages only for marking as read
        // Sender cannot edit their sent messages
        allow update: if isSignedIn() 
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants
          && request.resource.data.senderId == resource.data.senderId
          && request.resource.data.text == resource.data.text
          && request.resource.data.receiverId == resource.data.receiverId;
        
        // Prevent deletion of messages
        allow delete: if false;
      }
    }
    
    // Legacy chat room rules (keeping for backward compatibility) - Already secured
    match /chats/{chatId} {
      allow create: if isSignedIn() 
        && request.resource.data.participants.hasAll([request.auth.uid])
        && request.resource.data.participants.size() == 2;
      
      allow read: if isSignedIn() 
        && resource.data.participants.hasAny([request.auth.uid]);
      
      allow update: if isSignedIn() 
        && resource.data.participants.hasAny([request.auth.uid])
        && request.resource.data.participants == resource.data.participants;
      
      allow delete: if false;
      
      // Messages in chat rooms
      match /messages/{messageId} {
        allow create: if isSignedIn() 
          && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid])
          && request.resource.data.senderId == request.auth.uid;
        
        allow read: if isSignedIn() 
          && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
        
        allow update: if isSignedIn() 
          && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid])
          && request.resource.data.senderId == resource.data.senderId
          && request.resource.data.text == resource.data.text;
        
        allow delete: if false;
      }
    }
  }
}